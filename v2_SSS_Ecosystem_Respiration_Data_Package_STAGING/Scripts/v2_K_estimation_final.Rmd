---
title: "K estimation"
author: "MKAUFMAN"
date: "`r Sys.Date()`"
output: html_document
---
##Matthew Kaufman
#matthew.kaufman@pnnl.gov 
#Pacific Nortwest National Laboratory River Corridor SFA
#This script takes measured and modeled hydraulic conditions (velocity, slope, depth, and discharge) for various stream reaches and applies an empirical formula to estimate K600 from them

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## import depth and width data, slope data, discharge and velocity data, and combine
```{r message=FALSE}
library(tidyverse);library(dplyr)

data1<-read.csv("Inputs/SSS_Water_Depth_Summary.csv",skip=8) #from this data package: https://data.ess-dive.lbl.gov/datasets/doi:10.15485/1969566

data2<-read.csv("Inputs/v2_SSS_Slope_Discharge_Velocity.csv", skip = 6) #We obtained the streamflow and flow velocity from NOAA National Water Model (NWM) retrospective dataset using version 2.1 of NWM. The dataset provides a 42-year (February through December 2020) hourly simulation at all sampling locations (except COMID 24125857). We computed the monthly averaged streamflow and velocity in August across these simulation years. Slope was extracted from NHDplus v2.1


colnames(data2)<-c("Site_ID","comid","slope","discharge","velocity")

data1$Average_Depth_m=data1$Average_Depth/100

data = merge(data1,data2, by = 'Site_ID')
data = data %>% select("Site_ID","Average_Depth_m","discharge","velocity","slope")

```


## Estamate k600 using Raymond 2012 table 2 equation 7:  k600=4725 · (VS)^0.86 · Q^-0.14 · D^0.66
#k600 [m/d], velocity V [m/s], slpe S [-], depth D [m], discharge Q [m^3/s]

```{r message=FALSE}
data$k600_md<-4725*(data$velocity*data$slope)^0.86*data$discharge^-0.14*data$Average_Depth_m^0.66
data$K600_1_per_d = data$k600_md/data$Average_Depth_m

output<-data.frame(data[c("Site_ID","K600_1_per_d")])
colnames(output)=c("Site_ID","K600")
output$K600<-round(output$K600,2)

header <- tibble::tibble(header = c('# HeaderRows_4',
                            '# HeaderRows_Format: Column_Header; Unit; InstallationMethod_ID; Instrument_Summary', 
                            'K600; 1_per_day; N/A; Calculated using (1) depth (2) flow (3) velocity and (4) slope as inputs for the Raymond et al. (2012) table 2 equation 7. The result from that calculation is then divided by depth'))

write_csv(header, 'Inputs/v2_SSS_K600.csv', col_names = F)

write_csv(output, 'Inputs/v2_SSS_K600.csv', append = T, col_names = T)

```